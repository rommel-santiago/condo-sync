<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Work Permits</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <link rel="stylesheet" href="/css/navbar.css">

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body class="p-4">
<div th:replace="common/navigationBar :: navItemsBar"></div>

<div class="container-fluid mt-3">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="h5">
      Work Permits For Approval
      <span class="badge bg-warning ms-2" th:text="${#lists.size(workPermits)}"></span>
    </h2>
  </div>

  <table class="table table-bordered table-striped">
    <thead class="table-secondary">
    <tr>
      <th>Request Date/Time</th>
      <th>Unit</th>
      <th>Description</th>
      <th>Status</th>
      <th>Requested By</th>
      <th>Actions</th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="permit : ${workPermits}">
      <td th:text="${permit.formattedDateTime}"></td>
      <td th:text="${permit.assetFullName}"></td>
      <td th:text="${permit.workDescription}"></td>
      <td th:text="${permit.status}"></td>
      <td th:text="${permit.requesterName}"></td>
      <td>
        <button class="btn btn-primary btn-sm" th:attr="data-id=${permit.id}" onclick="editPermit(this)">Edit</button>
      </td>
    </tr>
    </tbody>
  </table>
</div>

<div class="modal fade" id="workPermitForm" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <form id="editForm">
        <div class="modal-header">
          <h5 class="modal-title">Edit Work Permit</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="id" name="id">

          <div class="row mb-2">
            <div class="col-md-12">
              <label class="fw-bold">Unit</label>
              <input type="text" class="form-control bg-light" id="assetFullName" name="assetFullName" readonly>
            </div>
          </div>

          <div class="row mb-2">
            <div class="col-md-6">
              <label class="fw-bold">Status</label>
              <input type="text" class="form-control bg-light" id="status" name="status" readonly>
            </div>
            <div class="col-md-6">
              <label class="fw-bold">Requester Name</label>
              <input type="text" class="form-control bg-light" id="requesterName" name="requesterName" readonly>
            </div>
          </div>

          <div class="row mb-2">
            <div class="col-md-4">
              <label class="fw-bold">Work Date</label>
              <input type="date" class="form-control" id="workDate" name="workDate">
            </div>
            <div class="col-md-4">
              <label class="fw-bold">Start Time</label>
              <input type="text" class="form-control" id="startTime" name="startTime">
            </div>
            <div class="col-md-4">
              <label class="fw-bold">Duration</label>
              <input type="number" class="form-control" id="duration" name="duration">
            </div>
          </div>

          <div class="mb-2">
            <label class="fw-bold">Description</label>
            <textarea class="form-control" id="workDescription" name="workDescription"></textarea>
          </div>

          <h5>Workers</h5>
          <div id="workerContainer" class="mb-3"></div>
          <div class="mb-3 ps-4">
            <button type="button" class="btn btn-success btn-sm" onclick="addRow('workerContainer', 'workers')">
              <i class="bi bi-plus-circle"></i> Worker
            </button>
          </div>

          <h5>Tools</h5>
          <div id="toolContainer" class="mb-3"></div>
          <div class="mb-3 ps-4">
            <button type="button" class="btn btn-success btn-sm" onclick="addRow('toolContainer', 'tools')">
              <i class="bi bi-plus-circle"></i> Tool
            </button>
          </div>

          <h5>Materials</h5>
          <div id="materialContainer" class="mb-3"></div>
          <div class="mb-3 ps-4">
            <button type="button" class="btn btn-success btn-sm" onclick="addRow('materialContainer', 'materials')">
              <i class="bi bi-plus-circle"></i> Material
            </button>
          </div>
        </div>

        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Save</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  function editPermit(button) {
    const $button = $(button);
    $button.prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status"></span>');
    const id = $button.data("id");

    $.get("/workPermit/" + id, function (data) {
      $('#id').val(data.id);
      $('#assetFullName').val(data.assetFullName);
      $('#status').val(data.status);
      $('#requesterName').val(data.requesterName);
      $('#workDate').val(data.workDate);
      $('#startTime').val(data.startTime);
      $('#duration').val(data.duration);
      $('#workDescription').val(data.workDescription);

      populateList("workerContainer", "workers", data.workers);
      populateList("toolContainer", "tools", data.tools);
      populateList("materialContainer", "materials", data.materials);

      new bootstrap.Modal(document.getElementById("workPermitForm")).show();
    }).always(function () {
      $button.prop('disabled', false).html('Edit');
    });
  }

  function populateList(containerId, type, items) {
    const container = $('#' + containerId);
    container.empty();
    items.forEach((item, index) => {
      const id = item.id || '';
      const name = item.name || '';
      container.append(buildRowHtml(type, index, id, name));
    });
  }

  function addRow(containerId, type) {
    const container = document.getElementById(containerId);
    const index = container.children.length;
    container.insertAdjacentHTML('beforeend', buildRowHtml(type, index, '', ''));
  }

  function buildRowHtml(type, index, idValue, nameValue) {
    return `
      <div class="row mb-2 align-items-center ps-4">
        <div class="col-md-12">
          <div class="input-group">
            <input type="hidden" name="${type}[${index}].id" value="${idValue}" />
            <input type="text" class="form-control" name="${type}[${index}].name" value="${nameValue}" placeholder="Name">
            <button type="button" class="btn btn-outline-danger" onclick="removeRow(this)">
              <i class="bi bi-trash"></i>
            </button>
          </div>
        </div>
      </div>`;
  }

  function removeRow(button) {
    const row = button.closest('.row');
    $(row).addClass('text-muted').css('opacity', '0.5');
    $(row).find('input, button').prop('disabled', true);
    $(row).append('<input type="hidden" name="deleted" value="true">');

    const undoBtn = $('<button type="button" class="btn btn-outline-secondary btn-sm ms-2">Undo</button>');
    undoBtn.on('click', function () {
      $(row).removeClass('text-muted').css('opacity', '1');
      $(row).find('input, button').prop('disabled', false);
      $(row).find("input[name='deleted']").remove();
      $(this).remove();
    });
    $(row).append(undoBtn);
  }

  function collectList(type) {
    const list = [];
    const rows = $(`#${type.slice(0, -1)}Container .row`);
    rows.each(function () {
      const $row = $(this);
      const id = $row.find(`input[name*='${type}'][name*='.id']`).val();
      const name = $row.find(`input[name*='${type}'][name*='.name']`).val();
      const isDeleted = $row.find("input[name='deleted']").length > 0;

      list.push({
        id: id ? parseInt(id) : null,
        name: name?.trim() || '',
        deleted: isDeleted
      });
    });
    return list;
  }

  $('#editForm').submit(function (e) {
    e.preventDefault();
    const data = {
      id: $('#id').val(),
      assetFullName: $('#assetFullName').val(),
      status: $('#status').val(),
      requesterName: $('#requesterName').val(),
      workDate: $('#workDate').val(),
      startTime: $('#startTime').val(),
      duration: $('#duration').val(),
      workDescription: $('#workDescription').val(),
      workers: collectList('workers'),
      tools: collectList('tools'),
      materials: collectList('materials')
    };

    $.ajax({
      url: '/workPermit/update',
      type: 'POST',
      contentType: 'application/json',
      data: JSON.stringify(data),
      success: function () {
        $('#workPermitForm').modal('hide');
        location.reload();
      },
      error: function () {
        alert('Failed to update work permit.');
      }
    });
  });
</script>
</body>
</html>
